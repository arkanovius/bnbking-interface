<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNBKing - Interface Compl√®te</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Karla:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #FFD700;
            --dark-gold: #B8860B;
            --gem: #40E0D0;
            --dark-gem: #20B2AA;
            --bg-dark: #0a0e27;
            --bg-card: #1a1f3a;
            --border: #2a3f5f;
            --text-light: #e0e6ed;
            --text-dim: #8892a6;
            --danger: #ff4757;
            --success: #2ed573;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:'Karla',sans-serif;
            background:linear-gradient(135deg,var(--bg-dark),#1a0f2e);
            color:var(--text-light);
            min-height:100vh;
            position:relative;
            overflow-x:hidden;
        }

        body::before {
            content:'';
            position:fixed;
            inset:0;
            background:radial-gradient(circle at 20% 30%,rgba(255,215,0,0.03) 0%,transparent 40%),
                       radial-gradient(circle at 80% 70%,rgba(64,224,208,0.03) 0%,transparent 40%);
            pointer-events:none;
            z-index:0;
        }

        .container {
            max-width:1400px;
            margin:0 auto;
            padding:20px;
            position:relative;
            z-index:1;
        }

        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:30px 0;
            border-bottom:2px solid var(--border);
            margin-bottom:40px;
            flex-wrap:wrap;
            gap:20px;
        }

        h1 {
            font-family:'Cinzel',serif;
            font-size:2.5em;
            font-weight:900;
            background:linear-gradient(135deg,var(--gold),var(--dark-gold));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            letter-spacing:2px;
        }

        .wallet-section {
            display:flex;
            gap:15px;
            align-items:center;
            flex-wrap:wrap;
        }

        button {
            padding:12px 28px;
            border:2px solid var(--gold);
            background:linear-gradient(135deg,var(--gold),var(--dark-gold));
            color:var(--bg-dark);
            font-weight:600;
            font-size:1em;
            cursor:pointer;
            border-radius:8px;
            transition:all 0.3s ease;
            text-transform:uppercase;
            letter-spacing:0.8px;
        }

        button:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(255,215,0,0.4); }
        button:disabled { opacity:0.5; cursor:not-allowed; }

        button.secondary {
            background:linear-gradient(135deg,var(--gem),var(--dark-gem));
            border-color:var(--gem);
        }

        button.danger {
            background:linear-gradient(135deg,var(--danger),#c23616);
            border-color:var(--danger);
            color:white;
        }

        .wallet-address {
            padding:10px 20px;
            background:var(--bg-card);
            border:1px solid var(--border);
            border-radius:8px;
            font-family:monospace;
            font-size:0.9em;
            color:var(--text-dim);
        }

        .stats-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
            gap:20px;
            margin-bottom:40px;
        }

        .stat-card {
            background:var(--bg-card);
            border:1px solid var(--border);
            border-radius:12px;
            padding:20px;
            transition:all 0.3s ease;
        }

        .stat-card:hover { transform:translateY(-5px); box-shadow:0 10px 30px rgba(255,215,0,0.2); }

        .stat-card::before {
            content:'';
            position:absolute;
            top:0; left:0; right:0;
            height:3px;
            background:linear-gradient(90deg,var(--gold),var(--gem));
        }

        .stat-label {
            font-size:0.85em;
            color:var(--text-dim);
            text-transform:uppercase;
            margin-bottom:8px;
        }

        .stat-value {
            font-size:1.8em;
            font-weight:700;
            font-family:'Cinzel',serif;
        }

        .stat-value.gold { color:var(--gold); }
        .stat-value.gem { color:var(--gem); }

        .gems-conversion {
            margin-top:10px;
            font-size:1em;
            color:var(--gem);
            text-align:center;
            background:rgba(64,224,208,0.1);
            border:1px solid var(--gem);
            border-radius:8px;
            padding:8px;
        }

        .section {
            background:var(--bg-card);
            border:1px solid var(--border);
            border-radius:12px;
            padding:30px;
            margin-bottom:30px;
        }

        .section-title {
            font-family:'Cinzel',serif;
            font-size:1.8em;
            margin-bottom:20px;
            color:var(--gold);
            border-bottom:2px solid var(--border);
            padding-bottom:15px;
        }

        .input-group { margin-bottom:20px; }

        label {
            display:block;
            margin-bottom:8px;
            color:var(--text-dim);
            font-weight:600;
            text-transform:uppercase;
            font-size:0.85em;
        }

        input, select {
            width:100%;
            padding:14px;
            background:var(--bg-dark);
            border:2px solid var(--border);
            border-radius:8px;
            color:var(--text-light);
            font-size:1em;
            transition:all 0.3s;
        }

        input:focus, select:focus {
            outline:none;
            border-color:var(--gold);
            box-shadow:0 0 20px rgba(255,215,0,0.2);
        }

        .grid-container {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
            gap:20px;
        }

        /* GRILLE INTERACTIVE */
        .building-grid-wrapper {
            background:var(--bg-dark);
            padding:20px;
            border-radius:12px;
            margin:20px 0;
            border:2px solid var(--border);
        }

        .building-grid {
            display:grid;
            grid-template-columns:repeat(20,1fr);
            gap:3px;
            max-width:100%;
            overflow-x:auto;
        }

        .tile {
            aspect-ratio:1;
            background:#0b1220;
            border:1px solid rgba(255,255,255,0.1);
            border-radius:4px;
            cursor:pointer;
            transition:all 0.2s ease;
            position:relative;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:0.7em;
            font-weight:bold;
            color:rgba(255,255,255,0.85);
            user-select:none;
        }

        .tile:hover {
            transform:scale(1.1);
            z-index:10;
            box-shadow:0 0 15px rgba(255,215,0,0.6);
        }

        .tile.empty { background:#0b1220; }
        
        /* Couleurs par niveau */
        .tile.level-1 { background:linear-gradient(135deg, #0ea5e9, #0284c7); }
        .tile.level-2 { background:linear-gradient(135deg, #22c55e, #16a34a); }
        .tile.level-3 { background:linear-gradient(135deg, #a3e635, #84cc16); }
        .tile.level-4 { background:linear-gradient(135deg, #f59e0b, #d97706); }
        .tile.level-5 { background:linear-gradient(135deg, #f97316, #ea580c); }
        .tile.level-6 { background:linear-gradient(135deg, #ef4444, #dc2626); }
        .tile.level-7 { background:linear-gradient(135deg, #a855f7, #9333ea); }
        .tile.level-8 { background:linear-gradient(135deg, #f5f5f5, #d4d4d4); color:#111827; }

        .tile.selected-build {
            border:2px solid #f59e0b !important;
            box-shadow:0 0 20px rgba(245,158,11,0.8);
        }

        .tile.selected-upgrade {
            border:2px solid #a855f7 !important;
            box-shadow:0 0 20px rgba(168,85,247,0.8);
        }

        .mode-selector {
            display:flex;
            gap:10px;
            margin-bottom:20px;
        }

        .mode-btn {
            padding:10px 20px;
            border-radius:999px;
            border:2px solid var(--border);
            background:#f3f4f6;
            color:#111827;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
        }

        .mode-btn.active {
            background:#16a34a;
            color:white;
            border-color:#16a34a;
        }

        .info-box {
            background:rgba(64,224,208,0.1);
            border:1px solid var(--gem);
            border-radius:8px;
            padding:15px;
            margin-bottom:20px;
            font-size:0.95em;
        }

        .cooldown-timer {
            font-size:1.2em;
            color:var(--danger);
            font-weight:bold;
            margin:12px 0;
        }

        .message {
            padding:15px 20px;
            border-radius:8px;
            margin:20px 0;
            font-weight:600;
        }

        .success { background:rgba(46,213,115,0.2); border:1px solid var(--success); color:var(--success); }
        .error { background:rgba(255,71,87,0.2); border:1px solid var(--danger); color:var(--danger); }
        .info { background:rgba(64,224,208,0.2); border:1px solid var(--gem); color:var(--gem); }

        .hidden { display:none; }

        footer {
            text-align:center;
            padding:40px 0 20px;
            color:var(--text-dim);
            font-size:0.9em;
            border-top:1px solid var(--border);
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .building-grid { grid-template-columns: repeat(15, 1fr); }
            h1 { font-size: 2em; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>‚öîÔ∏è BNBKing</h1>
            <div class="wallet-section">
                <button id="connectWalletBtn">Connecter Wallet</button>
                <div id="walletAddress" class="wallet-address hidden"></div>
                <button id="disconnectBtn" class="danger hidden">D√©connecter</button>
            </div>
        </header>

        <div id="messageContainer"></div>

        <div id="notConnected" class="section">
            <h2 class="section-title">Bienvenue sur BNBKing</h2>
            <p style="line-height:1.8; color:var(--text-dim);">
                Connectez votre wallet pour acc√©der √† votre royaume.
            </p>
        </div>

        <div id="gameInterface" class="hidden">

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">üí∞ Or (Gold)</div>
                    <div class="stat-value gold" id="goldAmount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üíé Gemmes (Gems)</div>
                    <div class="stat-value gem" id="gemsAmount">0</div>
                    <div class="gems-conversion" id="gemsValue">‚âà 0.000000 BNB (~$0.00)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚ö° Production / Heure</div>
                    <div class="stat-value" id="perHourAmount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üë• Alli√©s</div>
                    <div class="stat-value" id="alliesCount">0</div>
                </div>
            </div>

            <!-- Grille Interactive -->
            <div class="section">
                <h2 class="section-title">üè∞ Votre Royaume (Grille Interactive)</h2>
                
                <div class="mode-selector">
                    <button class="mode-btn active" id="buildModeBtn">üèóÔ∏è Construire</button>
                    <button class="mode-btn" id="upgradeModeBtn">‚¨ÜÔ∏è Am√©liorer</button>
                </div>

                <div id="buildMode">
                    <div class="info-box">
                        üí° <strong>Mode Construction:</strong> Cliquez sur les cases vides (noires) pour les s√©lectionner, choisissez le niveau, puis cliquez "Construire".
                    </div>
                    
                    <div class="input-group">
                        <label>Niveau du b√¢timent (1-8)</label>
                        <select id="buildingLevel">
                            <option value="1">Niveau 1 - 10,000 or ‚Üí +8/h</option>
                            <option value="2">Niveau 2 - 28,000 or ‚Üí +24/h</option>
                            <option value="3">Niveau 3 - 54,000 or ‚Üí +48/h</option>
                            <option value="4">Niveau 4 - 100,000 or ‚Üí +96/h</option>
                            <option value="5">Niveau 5 - 250,000 or ‚Üí +248/h</option>
                            <option value="6">Niveau 6 - 500,000 or ‚Üí +520/h</option>
                            <option value="7">Niveau 7 - 1,000,000 or ‚Üí +1,100/h</option>
                            <option value="8">Niveau 8 - 2,000,000 or ‚Üí +2,300/h</option>
                        </select>
                    </div>

                    <div style="margin-bottom:15px; color:var(--text-dim);">
                        <strong>S√©lection:</strong> <span id="selectedCount">0</span> case(s) | 
                        <strong>Co√ªt estim√©:</strong> <span id="estimatedCost">0</span> or | 
                        <strong>Production estim√©e:</strong> +<span id="estimatedProduction">0</span>/h
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button id="placeBuildingsBtn" style="flex:1;">üèóÔ∏è Construire</button>
                        <button id="clearSelectionBtn" class="secondary">‚ùå Effacer s√©lection</button>
                    </div>
                </div>

                <div id="upgradeMode" class="hidden">
                    <div class="info-box">
                        üí° <strong>Mode Am√©lioration:</strong> Cliquez sur un b√¢timent existant (case color√©e) pour le s√©lectionner, puis cliquez "Am√©liorer".
                    </div>

                    <div style="margin-bottom:15px; color:var(--text-dim);">
                        <strong>Case s√©lectionn√©e:</strong> <span id="selectedUpgradeTile">Aucune</span><br>
                        <strong>Info:</strong> <span id="upgradeTileInfo">‚Äî</span><br>
                        <strong>Co√ªt am√©lioration:</strong> <span id="upgradeCost">‚Äî</span> or | 
                        <strong>Production bonus:</strong> +<span id="upgradeProduction">‚Äî</span>/h
                    </div>

                    <button id="upgradeBuildingBtn" style="width:100%;">‚¨ÜÔ∏è Am√©liorer le b√¢timent</button>
                </div>

                <div class="building-grid-wrapper">
                    <div class="building-grid" id="buildingGrid"></div>
                </div>
            </div>

            <!-- Actions -->
            <div class="grid-container">
                <div class="section">
                    <h2 class="section-title">üíé Vendre des Gemmes</h2>
                    <div class="info-box">
                        Taux: 1,000,000 Gems = 1 BNB
                    </div>
                    <div class="input-group">
                        <label>Nombre de gemmes</label>
                        <input type="number" id="sellGemsAmount" placeholder="100000" step="1000" min="0">
                    </div>
                    <button onclick="sellGems()" style="width:100%;">üíé Vendre pour BNB</button>
                </div>

                <div class="section">
                    <h2 class="section-title">üîÑ √âchanger Gems ‚Üí Or</h2>
                    <div class="info-box">
                        Taux: 1 Gem = 2 Gold
                    </div>
                    <div class="input-group">
                        <label>Nombre de gemmes</label>
                        <input type="number" id="swapGemsAmount" placeholder="10000" step="1000" min="0">
                    </div>
                    <button onclick="swapGemsToGold()" class="secondary" style="width:100%;">‚ôªÔ∏è √âchanger</button>
                </div>
            </div>

            <!-- Battle -->
            <div class="section">
                <h2 class="section-title">‚öîÔ∏è Bataille</h2>
                <div id="battleCooldown" class="cooldown-timer hidden"></div>
                <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-end;">
                    <div class="input-group" style="flex:1; min-width:220px;">
                        <label>Chance de victoire (40-60%)</label>
                        <input type="number" id="winChance" placeholder="50" min="40" max="60" value="50">
                    </div>
                    <button onclick="startBattle()">‚öîÔ∏è Lancer Bataille</button>
                </div>
            </div>

        </div>

        <footer>
            <p>BNBKing ‚Äì Interface Communautaire | BSC</p>
            <p style="margin-top:8px; font-size:0.85em;">
                Contrat: 0x864EE1d1B51306e30836B84AdE81e39ebB6e8e0C
            </p>
        </footer>
    </div>

    <script>
        let provider, signer, contract, userAddress;
        let selectedBuildTiles = new Set();
        let selectedUpgradeTile = null;
        let currentMode = 'build';
        let kingdomData = null;
        let bnbPriceUSD = 600;

        const CONTRACT_ADDRESS = '0x864EE1d1B51306e30836B84AdE81e39ebB6e8e0C';

        const CONTRACT_ABI = [
            "function buyGold(address _ally) external payable",
            "function sellGems(uint256 _gems) external",
            "function swapGemsToGold(uint256 _gems) external",
            "function placeBuildings(uint16[] calldata _tileIds, uint8 _level) external",
            "function upgradeBuilding(uint16 _tileId) external",
            "function battle(uint8 _winChance) external",
            "function getKingdom(address _player) external view returns (tuple(uint32 gold, uint32 gems, uint32 perHour, uint32 alliesCount, uint32 alliesEarned, uint32 claimTime, uint32 battleTime, uint16 battleId, uint8 battlesInRow, bool isWinInRow, address ally, uint8[360] tiles))"
        ];

        const BUILDING_STATS = {
            1: { cost: 10000, perHour: 8 },
            2: { cost: 28000, perHour: 24 },
            3: { cost: 54000, perHour: 48 },
            4: { cost: 100000, perHour: 96 },
            5: { cost: 250000, perHour: 248 },
            6: { cost: 500000, perHour: 520 },
            7: { cost: 1000000, perHour: 1100 },
            8: { cost: 2000000, perHour: 2300 }
        };

        function decodeTile(value) {
            const v = Number(value);
            if (v === 0) return { empty: true, level: 0, upgrades: 0 };
            const level = v % 10;
            const upgrades = Math.floor(v / 10);
            return { empty: false, level, upgrades };
        }

        // Mode switching
        document.getElementById('buildModeBtn').onclick = () => {
            currentMode = 'build';
            document.getElementById('buildMode').classList.remove('hidden');
            document.getElementById('upgradeMode').classList.add('hidden');
            document.getElementById('buildModeBtn').classList.add('active');
            document.getElementById('upgradeModeBtn').classList.remove('active');
            selectedUpgradeTile = null;
            renderGrid();
        };

        document.getElementById('upgradeModeBtn').onclick = () => {
            currentMode = 'upgrade';
            document.getElementById('buildMode').classList.add('hidden');
            document.getElementById('upgradeMode').classList.remove('hidden');
            document.getElementById('buildModeBtn').classList.remove('active');
            document.getElementById('upgradeModeBtn').classList.add('active');
            selectedBuildTiles.clear();
            renderGrid();
        };

        // Connexion wallet
        document.getElementById('connectWalletBtn').onclick = async () => {
            try {
                if (!window.ethereum) {
                    alert('Wallet non d√©tect√©!');
                    return;
                }

                let chainId = await window.ethereum.request({method:'eth_chainId'});
                if (chainId !== '0x38') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x38' }]
                        });
                    } catch (switchErr) {
                        if (switchErr.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x38',
                                    chainName: 'Binance Smart Chain',
                                    nativeCurrency: {name:'BNB', symbol:'BNB', decimals:18},
                                    rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                    blockExplorerUrls: ['https://bscscan.com/']
                                }]
                            });
                        }
                    }
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('walletAddress').textContent = 
                    userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('walletAddress').classList.remove('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                document.getElementById('connectWalletBtn').classList.add('hidden');
                document.getElementById('notConnected').classList.add('hidden');
                document.getElementById('gameInterface').classList.remove('hidden');

                showMessage('Wallet connect√©!', 'success');
                await loadKingdom();
                fetchBNBPrice();

            } catch (err) {
                showMessage('Erreur: ' + err.message, 'error');
            }
        };

        document.getElementById('disconnectBtn').onclick = () => {
            provider = signer = contract = userAddress = null;
            document.getElementById('walletAddress').classList.add('hidden');
            document.getElementById('disconnectBtn').classList.add('hidden');
            document.getElementById('connectWalletBtn').classList.remove('hidden');
            document.getElementById('notConnected').classList.remove('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
        };

        async function loadKingdom() {
            if (!contract || !userAddress) return;
            try {
                const k = await contract.getKingdom(userAddress);
                
                kingdomData = {
                    gold: Number(k.gold),
                    gems: Number(k.gems),
                    perHour: Number(k.perHour),
                    alliesCount: Number(k.alliesCount),
                    battleTime: Number(k.battleTime),
                    tiles: Array.from(k.tiles).map(x => Number(x))
                };

                document.getElementById('goldAmount').textContent = kingdomData.gold.toLocaleString();
                document.getElementById('gemsAmount').textContent = kingdomData.gems.toLocaleString();
                document.getElementById('perHourAmount').textContent = kingdomData.perHour.toLocaleString();
                document.getElementById('alliesCount').textContent = kingdomData.alliesCount;

                updateGemsConversion();
                updateBattleCooldown();
                renderGrid();

            } catch (err) {
                showMessage('Erreur chargement: ' + err.message, 'error');
            }
        }

        function renderGrid() {
            if (!kingdomData) return;

            const grid = document.getElementById('buildingGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 360; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                const info = decodeTile(kingdomData.tiles[i]);

                if (info.empty) {
                    tile.classList.add('empty');
                    tile.textContent = '';
                } else {
                    tile.classList.add(`level-${info.level}`);
                    tile.textContent = info.upgrades > 0 ? `${info.level}+${info.upgrades}` : `${info.level}`;
                }

                if (currentMode === 'build') {
                    if (info.empty) {
                        if (selectedBuildTiles.has(i)) {
                            tile.classList.add('selected-build');
                        }
                        tile.onclick = () => toggleBuildTile(i);
                    } else {
                        tile.style.cursor = 'not-allowed';
                        tile.style.opacity = '0.5';
                    }
                } else {
                    if (!info.empty && info.upgrades < 9 && info.level >= 1 && info.level <= 8) {
                        if (selectedUpgradeTile === i) {
                            tile.classList.add('selected-upgrade');
                        }
                        tile.onclick = () => selectUpgradeTile(i);
                    } else {
                        tile.style.cursor = 'not-allowed';
                        tile.style.opacity = '0.5';
                    }
                }

                tile.title = `Tile ${i} - Level ${info.level} - Upgrades ${info.upgrades}`;
                grid.appendChild(tile);
            }

            updateBuildEstimates();
        }

        function toggleBuildTile(tileId) {
            if (selectedBuildTiles.has(tileId)) {
                selectedBuildTiles.delete(tileId);
            } else {
                selectedBuildTiles.add(tileId);
            }
            renderGrid();
        }

        function selectUpgradeTile(tileId) {
            selectedUpgradeTile = tileId;
            renderGrid();
            updateUpgradeInfo();
        }

        function updateBuildEstimates() {
            const level = parseInt(document.getElementById('buildingLevel').value);
            const stats = BUILDING_STATS[level];
            const count = selectedBuildTiles.size;

            document.getElementById('selectedCount').textContent = count;
            document.getElementById('estimatedCost').textContent = (stats.cost * count).toLocaleString();
            document.getElementById('estimatedProduction').textContent = (stats.perHour * count).toLocaleString();
        }

        function updateUpgradeInfo() {
            if (selectedUpgradeTile === null || !kingdomData) {
                document.getElementById('selectedUpgradeTile').textContent = 'Aucune';
                document.getElementById('upgradeTileInfo').textContent = '‚Äî';
                document.getElementById('upgradeCost').textContent = '‚Äî';
                document.getElementById('upgradeProduction').textContent = '‚Äî';
                return;
            }

            const info = decodeTile(kingdomData.tiles[selectedUpgradeTile]);
            const stats = BUILDING_STATS[info.level];
            const cost = Math.floor(stats.cost / 4);
            const production = Math.floor(stats.perHour / 4);

            document.getElementById('selectedUpgradeTile').textContent = selectedUpgradeTile;
            document.getElementById('upgradeTileInfo').textContent = `Level ${info.level}, Upgrades ${info.upgrades}`;
            document.getElementById('upgradeCost').textContent = cost.toLocaleString();
            document.getElementById('upgradeProduction').textContent = production.toLocaleString();
        }

        document.getElementById('buildingLevel').onchange = updateBuildEstimates;

        document.getElementById('clearSelectionBtn').onclick = () => {
            selectedBuildTiles.clear();
            renderGrid();
        };

        document.getElementById('placeBuildingsBtn').onclick = async () => {
            if (!contract) return showMessage('Connectez votre wallet', 'error');
            if (selectedBuildTiles.size === 0) return showMessage('S√©lectionnez au moins une case', 'error');

            const level = parseInt(document.getElementById('buildingLevel').value);
            const tileIds = Array.from(selectedBuildTiles).sort((a, b) => a - b);

            try {
                showMessage('Transaction en cours...', 'info');
                const tx = await contract.placeBuildings(tileIds, level);
                await tx.wait();
                showMessage('B√¢timents construits!', 'success');
                selectedBuildTiles.clear();
                await loadKingdom();
            } catch (e) {
                showMessage('Erreur: ' + (e.reason || e.message), 'error');
            }
        };

        document.getElementById('upgradeBuildingBtn').onclick = async () => {
            if (!contract) return showMessage('Connectez votre wallet', 'error');
            if (selectedUpgradeTile === null) return showMessage('S√©lectionnez un b√¢timent', 'error');

            try {
                showMessage('Transaction en cours...', 'info');
                const tx = await contract.upgradeBuilding(selectedUpgradeTile);
                await tx.wait();
                showMessage('B√¢timent am√©lior√©!', 'success');
                selectedUpgradeTile = null;
                await loadKingdom();
            } catch (e) {
                showMessage('Erreur: ' + (e.reason || e.message), 'error');
            }
        };

        async function sellGems() {
            if (!contract) return showMessage('Connectez votre wallet', 'error');
            const amt = document.getElementById('sellGemsAmount').value;
            if (!amt || +amt <= 0) return showMessage('Montant invalide', 'error');

            try {
                showMessage('Transaction en cours...', 'info');
                const tx = await contract.sellGems(amt);
                await tx.wait();
                showMessage('Gemmes vendues!', 'success');
                await loadKingdom();
            } catch (e) {
                showMessage('Erreur: ' + (e.reason || e.message), 'error');
            }
        }

        async function swapGemsToGold() {
            if (!contract) return showMessage('Connectez votre wallet', 'error');
            const amt = document.getElementById('swapGemsAmount').value;
            if (!amt || +amt <= 0) return showMessage('Montant invalide', 'error');

            try {
                showMessage('Transaction en cours...', 'info');
                const tx = await contract.swapGemsToGold(amt);
                await tx.wait();
                showMessage('√âchange effectu√©!', 'success');
                await loadKingdom();
            } catch (e) {
                showMessage('Erreur: ' + (e.reason || e.message), 'error');
            }
        }

        async function startBattle() {
            if (!contract) return showMessage('Connectez votre wallet', 'error');
            const chance = +document.getElementById('winChance').value;
            if (!chance || chance < 40 || chance > 60) return showMessage('Chance invalide (40-60)', 'error');

            try {
                showMessage('Bataille en cours...', 'info');
                const tx = await contract.battle(chance);
                await tx.wait();
                showMessage('Bataille termin√©e!', 'success');
                await loadKingdom();
            } catch (e) {
                showMessage('Erreur: ' + (e.reason || e.message), 'error');
            }
        }

        function updateGemsConversion() {
            const gems = kingdomData ? kingdomData.gems : 0;
            const bnbVal = gems / 1_000_000;
            const usdVal = bnbVal * bnbPriceUSD;
            document.getElementById('gemsValue').textContent = 
                `‚âà ${bnbVal.toFixed(6)} BNB (~$${usdVal.toFixed(2)})`;
        }

        async function fetchBNBPrice() {
            try {
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
                const data = await res.json();
                if (data?.binancecoin?.usd) {
                    bnbPriceUSD = data.binancecoin.usd;
                    updateGemsConversion();
                }
            } catch {}
        }

        function updateBattleCooldown() {
            if (!kingdomData) return;
            const cd = document.getElementById('battleCooldown');
            const now = Math.floor(Date.now() / 1000);
            const diff = now - kingdomData.battleTime;
            
            if (diff < 86400) {
                const rem = 86400 - diff;
                const h = Math.floor(rem / 3600);
                const m = Math.floor((rem % 3600) / 60);
                cd.textContent = `‚è±Ô∏è Cooldown: ${h}h ${m}m`;
                cd.classList.remove('hidden');
            } else {
                cd.classList.add('hidden');
            }
        }

        function showMessage(text, type = 'info') {
            const c = document.getElementById('messageContainer');
            const m = document.createElement('div');
            m.className = `message ${type}`;
            m.textContent = text;
            c.appendChild(m);
            setTimeout(() => m.remove(), 5000);
        }

        setInterval(() => {
            if (contract && userAddress) loadKingdom();
        }, 30000);

        setInterval(fetchBNBPrice, 300000);
    </script>
</body>
</html>
