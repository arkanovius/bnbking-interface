async function connectWallet() {
    try {
        if (!window.ethereum) {
            showMessage("MetaMask ou Rabby n'est pas installé ou pas détecté.", 'error');
            return;
        }

        console.log("Tentative de connexion...");

        // Force switch BSC
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: '0x38' }],
            });
        } catch (switchError) {
            if (switchError.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: '0x38',
                        chainName: 'Binance Smart Chain',
                        nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                        rpcUrls: ['https://bsc-dataseed.binance.org/'],
                        blockExplorerUrls: ['https://bscscan.com/']
                    }]
                });
            } else {
                throw switchError;
            }
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        console.log("Connecté :", userAddress);

        document.getElementById('walletAddress').textContent = 
            userAddress.substring(0,6) + '...' + userAddress.substring(38);
        document.getElementById('walletAddress').classList.remove('hidden');
        document.getElementById('disconnectBtn').classList.remove('hidden');
        document.getElementById('connectWalletBtn').classList.add('hidden');
        document.getElementById('notConnected').classList.add('hidden');
        document.getElementById('gameInterface').classList.remove('hidden');

        showMessage('Wallet connecté avec succès !', 'success');

        const savedAddress = localStorage.getItem('contractAddress');
        if (savedAddress) {
            document.getElementById('contractAddress').value = savedAddress;
            await setContractAddress();
        }
    } catch (error) {
        console.error("Erreur complète :", error);
        showMessage('Erreur connexion : ' + (error.message || error.reason || 'Inconnu'), 'error');
    }
}
