<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BNBKing - Interface de Jeu</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --gold: #FFD700;
      --dark-gold: #B8860B;
      --gem: #40E0D0;
      --dark-gem: #20B2AA;
      --bg-dark: #0a0e27;
      --bg-card: #1a1f3a;
      --border: #2a3f5f;
      --text-light: #e0e6ed;
      --text-dim: #8892a6;
      --danger: #ff4757;
      --success: #2ed573;
    }

    body {
      font-family: 'Karla', sans-serif;
      background: linear-gradient(135deg, var(--bg-dark), #1a0f2e);
      color: var(--text-light);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: 2.5rem;
      background: linear-gradient(135deg, var(--gold), var(--dark-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    button {
      padding: 10px 20px;
      border: 2px solid var(--gold);
      background: linear-gradient(135deg, var(--gold), var(--dark-gold));
      color: var(--bg-dark);
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
    }

    button.secondary { background: linear-gradient(135deg, var(--gem), var(--dark-gem)); border-color: var(--gem); }

    .section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 25px; }

    .section-title { color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.6rem; margin-bottom: 15px; }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      gap: 3px;
      background: #0d1326;
      padding: 10px;
      border-radius: 10px;
      max-width: 100%;
      overflow-x: auto;
    }

    .tile {
      aspect-ratio: 1;
      background: var(--border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tile:hover { background: #3a4f6f; transform: scale(1.05); }

    .tile.occupied {
      background: linear-gradient(135deg, var(--gold), var(--dark-gold));
      color: var(--bg-dark);
      cursor: default;
    }

    .tile.selected { outline: 3px solid var(--gem); outline-offset: -3px; }

    .action-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 15px 0;
      align-items: center;
    }

    .status {
      padding: 10px 16px;
      border-radius: 8px;
      margin: 12px 0;
      font-weight: 500;
    }

    .success { background: rgba(46,213,115,0.2); border: 1px solid var(--success); }
    .error   { background: rgba(239,68,68,0.2);  border: 1px solid var(--danger);  }

    .hidden { display: none; }
  </style>
</head>
<body>

<div class="container">

  <header>
    <h1>‚öîÔ∏è BNBKing</h1>
    <div>
      <button id="connectWallet">Connecter Wallet</button>
      <span id="walletAddr" style="margin-left:12px; font-family:monospace;"></span>
    </div>
  </header>

  <div id="statusArea"></div>

  <div class="section">
    <div class="section-title">üè∞ Gestion des b√¢timents</div>

    <div class="action-row">
      <button onclick="setMode('place')">Mode : Placer</button>
      <button onclick="setMode('upgrade')">Mode : Am√©liorer</button>
      <button onclick="clearSelection()" class="secondary">Effacer s√©lection</button>
      <span style="margin-left: auto;">
        Cases s√©lectionn√©es : <strong id="selectedCount">0</strong>
      </span>
    </div>

    <div id="placeControls" class="action-row" style="display:none;">
      <label>Niveau √† construire :</label>
      <select id="buildLevel">
        <option value="1">Niv.1 - 10k gold (8/h)</option>
        <option value="2">Niv.2 - 28k gold (24/h)</option>
        <option value="3">Niv.3 - 54k gold (48/h)</option>
        <option value="4">Niv.4 - 100k gold (96/h)</option>
        <option value="5">Niv.5 - 250k gold (248/h)</option>
        <option value="6">Niv.6 - 500k gold (520/h)</option>
        <option value="7">Niv.7 - 1M gold (1100/h)</option>
        <option value="8">Niv.8 - 2M gold (2300/h)</option>
      </select>
      <button onclick="placeBuildings()">Construire sur s√©lection</button>
    </div>

    <div id="upgradeControls" class="action-row" style="display:none;">
      <span>Case s√©lectionn√©e : <strong id="upgradeId">‚Äî</strong></span>
      <button onclick="upgradeBuilding()">Am√©liorer cette case</button>
    </div>

    <div id="buildingGrid" class="grid-container"></div>
  </div>

</div>

<script>
  let provider, signer, contract;
  let mode = "place";
  let selectedTiles = new Set();
  let upgradeTile = null;

  const CONTRACT_ADDRESS = "0x864EE1d1B51306e30836B84AdE81e39ebB6e8e0C"; // ‚Üê change si besoin
  const ABI = [
    "function placeBuildings(uint16[] calldata _tileIds, uint8 _level) external",
    "function upgradeBuilding(uint16 _tileId) external",
    "function getKingdom(address _player) external view returns (tuple(uint32 gold, uint32 gems, uint32 perHour, uint32 alliesCount, uint32 alliesEarned, uint32 claimTime, uint32 battleTime, uint16 battleId, uint8 battlesInRow, bool isWinInRow, address ally, uint8[360] tiles))"
  ];

  async function connectWallet() {
    if (!window.ethereum) return showMessage("MetaMask / Rabby non d√©tect√©", "error");

    try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      const addr = await signer.getAddress();

      document.getElementById("walletAddr").textContent = addr.slice(0,6) + "..." + addr.slice(-4);
      document.getElementById("connectWallet").textContent = "Connect√©";

      contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      showMessage("Wallet connect√© !", "success");
      await loadTiles();
    } catch (e) {
      showMessage("Erreur connexion : " + e.message, "error");
    }
  }

  async function loadTiles() {
    if (!contract) return;
    try {
      const kingdom = await contract.getKingdom(await signer.getAddress());
      const tiles = Array.from(kingdom.tiles).map(Number);
      renderGrid(tiles);
    } catch (e) {
      showMessage("Impossible de charger la grille", "error");
    }
  }

  function renderGrid(tilesArray) {
    const grid = document.getElementById("buildingGrid");
    grid.innerHTML = "";

    for (let i = 0; i < 360; i++) {
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.id = i;

      const val = tilesArray[i];
      if (val > 0) {
        const level = val % 10;
        const upgrades = Math.floor(val / 10);
        tile.classList.add("occupied");
        tile.textContent = level + (upgrades ? "+" + upgrades : "");
      } else {
        tile.onclick = () => handleTileClick(i);
      }

      if (selectedTiles.has(i)) tile.classList.add("selected");
      if (upgradeTile === i) tile.classList.add("selected");

      grid.appendChild(tile);
    }
  }

  function handleTileClick(id) {
    const tile = document.querySelector(`.tile[data-id="${id}"]`);
    if (!tile) return;

    if (mode === "place") {
      if (tile.classList.contains("occupied")) return;
      if (selectedTiles.has(id)) {
        selectedTiles.delete(id);
        tile.classList.remove("selected");
      } else {
        selectedTiles.add(id);
        tile.classList.add("selected");
      }
      document.getElementById("selectedCount").textContent = selectedTiles.size;
    } 
    else if (mode === "upgrade") {
      if (!tile.classList.contains("occupied")) return;
      upgradeTile = (upgradeTile === id) ? null : id;
      renderGrid(kingdom?.tiles || []); // re-render pour mettre √† jour le visuel
      document.getElementById("upgradeId").textContent = upgradeTile !== null ? upgradeTile : "‚Äî";
    }
  }

  function setMode(newMode) {
    mode = newMode;
    if (newMode === "place") {
      upgradeTile = null;
      document.getElementById("placeControls").style.display = "flex";
      document.getElementById("upgradeControls").style.display = "none";
    } else {
      selectedTiles.clear();
      document.getElementById("placeControls").style.display = "none";
      document.getElementById("upgradeControls").style.display = "flex";
      document.getElementById("upgradeId").textContent = "‚Äî";
    }
    document.getElementById("selectedCount").textContent = selectedTiles.size;
    renderGrid(kingdom?.tiles || []);
  }

  function clearSelection() {
    selectedTiles.clear();
    document.getElementById("selectedCount").textContent = 0;
    renderGrid(kingdom?.tiles || []);
  }

  async function placeBuildings() {
    if (selectedTiles.size === 0) return showMessage("S√©lectionne au moins une case", "error");
    if (!contract) return showMessage("Connecte ton wallet d'abord", "error");

    const level = Number(document.getElementById("buildLevel").value);
    const tileIds = Array.from(selectedTiles);

    try {
      showMessage("Transaction en cours...", "success");
      const tx = await contract.placeBuildings(tileIds, level);
      await tx.wait();
      showMessage("B√¢timents plac√©s !", "success");
      selectedTiles.clear();
      document.getElementById("selectedCount").textContent = 0;
      await loadTiles();
    } catch (e) {
      showMessage("Erreur : " + (e.reason || e.message), "error");
    }
  }

  async function upgradeBuilding() {
    if (upgradeTile === null) return showMessage("S√©lectionne une case √† am√©liorer", "error");
    if (!contract) return showMessage("Connecte ton wallet d'abord", "error");

    try {
      showMessage("Transaction en cours...", "success");
      const tx = await contract.upgradeBuilding(upgradeTile);
      await tx.wait();
      showMessage("B√¢timent am√©lior√© !", "success");
      upgradeTile = null;
      document.getElementById("upgradeId").textContent = "‚Äî";
      await loadTiles();
    } catch (e) {
      showMessage("Erreur : " + (e.reason || e.message), "error");
    }
  }

  function showMessage(text, type = "success") {
    const area = document.getElementById("statusArea");
    area.innerHTML = `<div class="status ${type}">${text}</div>`;
    setTimeout(() => { area.innerHTML = ""; }, 6000);
  }

  // Init
  document.getElementById("connectWallet").onclick = connectWallet;
  setMode("place"); // mode par d√©faut
</script>

</body>
</html>
