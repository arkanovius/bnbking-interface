<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNBKing - Remastered</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Karla:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #FFD700;
            --dark-gold: #B8860B;
            --gem: #40E0D0;
            --dark-gem: #20B2AA;
            --silver: #C0C0C0;
            --bg-dark: #0a0e27;
            --bg-card: rgba(26,31,58,0.85);
            --border: #2a3f5f;
            --text-light: #e0e6ed;
            --text-dim: #8892a6;
            --danger: #ff4757;
            --success: #2ed573;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family:'Karla',sans-serif;
            background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            color:var(--text-light);
            min-height:100vh;
            position:relative;
        }

        body::before {
            content:'';
            position:fixed;
            inset:0;
            background:linear-gradient(to bottom, rgba(10,14,39,0.75), rgba(26,15,46,0.85));
            pointer-events:none;
            z-index:0;
        }

        .container {
            max-width:1400px;
            margin:0 auto;
            padding:20px;
            position:relative;
            z-index:1;
        }

        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:30px 0;
            margin-bottom:40px;
            flex-wrap:wrap;
            gap:20px;
        }

        h1 {
            font-family:'Cinzel',serif;
            font-size:3em;
            font-weight:900;
            background:linear-gradient(135deg,var(--gold),var(--dark-gold));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            text-shadow:0 0 20px rgba(255,215,0,0.4);
        }

        .wallet-section { display:flex; gap:15px; align-items:center; flex-wrap:wrap; }

        button {
            padding:12px 28px;
            border:2px solid var(--gold);
            background:linear-gradient(135deg,var(--gold),var(--dark-gold));
            color:#0a0e27;
            font-weight:600;
            font-size:1em;
            cursor:pointer;
            border-radius:8px;
            transition:all 0.3s;
        }

        button:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(255,215,0,0.5); }

        .wallet-address {
            padding:10px 20px;
            background:var(--bg-card);
            border:1px solid var(--border);
            border-radius:8px;
            font-family:monospace;
            font-size:0.9em;
        }

        .stats-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
            gap:20px;
            margin-bottom:40px;
        }

        .stat-card {
            background:var(--bg-card);
            border:1px solid var(--border);
            border-radius:16px;
            padding:20px;
            backdrop-filter:blur(6px);
        }

        .production-bar {
            margin:15px 0;
            background:rgba(0,0,0,0.4);
            border-radius:12px;
            padding:12px;
            display:flex;
            align-items:center;
            gap:12px;
            font-size:1.1em;
        }

        .silver-bar { border:2px solid var(--silver); color:var(--silver); }
        .gem-bar   { border:2px solid var(--gem);   color:var(--gem);   }

        .gems-conversion {
            margin-top:10px;
            text-align:center;
            color:var(--gem);
            font-size:1.1em;
            background:rgba(64,224,208,0.1);
            border:1px solid var(--gem);
            border-radius:8px;
            padding:10px;
        }

        .purchase-section {
            background:var(--bg-card);
            border:2px solid var(--dark-gold);
            border-radius:16px;
            padding:25px;
            margin:30px 0;
        }

        .purchase-header {
            font-size:1.8em;
            color:var(--gold);
            text-align:center;
            margin-bottom:20px;
            text-shadow:0 0 10px var(--gold);
        }

        .toggle-container {
            display:flex;
            justify-content:center;
            align-items:center;
            gap:20px;
            margin:20px 0;
        }

        .toggle-label {
            font-size:1.3em;
            font-weight:bold;
        }

        .toggle {
            position:relative;
            width:80px;
            height:40px;
            background:#444;
            border-radius:40px;
            cursor:pointer;
        }

        .toggle::before {
            content:'';
            position:absolute;
            width:36px;
            height:36px;
            background:var(--gold);
            border-radius:50%;
            top:2px;
            left:2px;
            transition:0.3s;
        }

        .toggle.active { background:var(--gem); }
        .toggle.active::before { left:42px; background:#fff; }

        .input-row {
            display:flex;
            gap:20px;
            margin:20px 0;
            flex-wrap:wrap;
        }

        .input-box {
            flex:1;
            min-width:220px;
            background:rgba(0,0,0,0.4);
            border:1px solid var(--border);
            border-radius:12px;
            padding:15px;
            text-align:center;
        }

        .buy-btn {
            background:linear-gradient(135deg,#2ed573,#27ae60);
            color:white;
            border:none;
            padding:16px 40px;
            font-size:1.3em;
            border-radius:12px;
            cursor:pointer;
            margin:20px auto;
            display:block;
            width:fit-content;
        }

        .buy-btn:hover { transform:scale(1.05); }

        .building-grid {
            display:grid;
            grid-template-columns:repeat(20,1fr);
            gap:3px;
            background:rgba(0,0,0,0.5);
            padding:12px;
            border-radius:12px;
            margin-top:20px;
            max-width:100%;
            overflow-x:auto;
        }

        .tile {
            aspect-ratio:1;
            background:var(--border);
            border:1px solid #111;
            position:relative;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:0.7em;
            color:#8892a6;
        }

        .tile:hover { background:var(--gold); transform:scale(1.08); }

        .tile.occupied {
            background:linear-gradient(135deg,var(--gold),var(--dark-gold));
            color:#0a0e27;
            font-weight:bold;
        }

        .tile-number {
            position:absolute;
            top:4px;
            left:4px;
            font-size:0.65em;
            font-weight:bold;
            color:var(--gold);
            text-shadow:0 0 3px #000;
            pointer-events:none;
            z-index:5;
        }

        .hidden { display:none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è BNBKing</h1>
            <div class="wallet-section">
                <button id="connectWalletBtn">Connecter Wallet</button>
                <div id="walletAddress" class="wallet-address hidden"></div>
                <button id="disconnectBtn" class="danger hidden">D√©connecter</button>
            </div>
        </header>

        <div id="messageContainer"></div>

        <div id="notConnected" class="section">
            <h2 class="section-title">Bienvenue sur BNBKing</h2>
            <p>Connectez votre wallet pour jouer, gagner des gems et d√©velopper votre royaume.</p>
        </div>

        <div id="gameInterface" class="hidden">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">üí∞ Or (Gold)</div>
                    <div class="stat-value gold" id="goldAmount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üíé Gemmes (Gems)</div>
                    <div class="stat-value gem" id="gemsAmount">0</div>
                    <div class="gems-conversion" id="gemsValue">‚âà 0.000000 BNB (~0.00 USDT)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚ö° Production / Heure</div>
                    <div class="stat-value" id="perHourAmount">0</div>
                </div>
            </div>

            <!-- Production Bars -->
            <div class="production-bar silver-bar">
                <img src="https://img.icons8.com/fluency/48/000000/coin.png" alt="Silver" width="32">
                <span>+0 Silver / Hour</span>
                <button style="margin-left:auto;background:var(--silver);color:#000">+</button>
            </div>

            <div class="production-bar gem-bar">
                <img src="https://img.icons8.com/fluency/48/000000/gem-stone.png" alt="Gems" width="32">
                <span>+0 Gems / Hour</span>
                <button style="margin-left:auto;background:var(--gem);color:#000">+</button>
            </div>

            <!-- Purchase / Swap Section -->
            <div class="purchase-section">
                <div class="purchase-header">Purchase</div>

                <div class="toggle-container">
                    <span class="toggle-label">BNB</span>
                    <div class="toggle" id="toggleSwitch"></div>
                    <span class="toggle-label">GEMS</span>
                </div>

                <div class="input-row">
                    <div class="input-box">
                        <strong>Give</strong><br>
                        <span id="giveAmount">0 BNB</span>
                    </div>
                    <div class="input-box">
                        <strong>Receive</strong><br>
                        <span id="receiveAmount">0 SILVER</span>
                    </div>
                </div>

                <button class="buy-btn" onclick="alert('Fonction achat simul√©e')">Buy Silver</button>

                <div style="text-align:center;margin-top:15px;">
                    1 BNB ‚âà 1,000,000 SILVER
                </div>
            </div>

            <!-- Buildings Grid -->
            <div class="section">
                <h2 class="section-title">üè∞ Construire des B√¢timents</h2>
                <div class="building-grid" id="buildingGrid"></div>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, contract, userAddress;
        let selectedTiles = new Set();
        let lastClaimTime = 0;
        let perHourCached = 0;
        let bnbPriceUSD = 600;

        const CONTRACT_ABI = [
            "function getKingdom(address) view returns (tuple(uint32 gold, uint32 gems, uint32 perHour, uint32 alliesCount, uint32 alliesEarned, uint32 claimTime, uint32 battleTime, uint16 battleId, uint8 battlesInRow, bool isWinInRow, address ally, uint8[360] tiles))",
            "function buyGold(address _ally) external payable",
            "function sellGems(uint256 _gems) external",
            "function swapGemsToGold(uint256 _gems) external",
            "function placeBuildings(uint16[] calldata _tileIds, uint8 _level) external",
            "function upgradeBuilding(uint16 _tileId) external",
            "function battle(uint8 _winChance) external"
        ];

        async function connectWallet() {
            if (!window.ethereum) return alert("Installe MetaMask ou Rabby !");
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            contract = new ethers.Contract("0x864EE1d1B51306e30836B84AdE81e39ebB6e8e0C", CONTRACT_ABI, signer);
            userAddress = await signer.getAddress();

            document.getElementById('walletAddress').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
            document.getElementById('walletAddress').classList.remove('hidden');
            document.getElementById('notConnected').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');

            await loadKingdomData();
        }

        async function loadKingdomData() {
            if (!contract) return;
            try {
                const kingdom = await contract.getKingdom(userAddress);
                document.getElementById('goldAmount').textContent = kingdom.gold.toNumber().toLocaleString();
                document.getElementById('gemsAmount').textContent = kingdom.gems.toNumber().toLocaleString();
                document.getElementById('perHourAmount').textContent = kingdom.perHour.toNumber().toLocaleString();

                lastClaimTime = Number(kingdom.claimTime);
                perHourCached = Number(kingdom.perHour);

                renderBuildingGrid(kingdom.tiles);
                updateGemsConversion();
            } catch(e) {
                console.error(e);
            }
        }

        function renderBuildingGrid(tiles) {
            const grid = document.getElementById('buildingGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 360; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';

                const num = document.createElement('div');
                num.className = 'tile-number';
                num.textContent = i;
                tile.appendChild(num);

                if (tiles[i] > 0) {
                    tile.classList.add('occupied');
                    const lvl = tiles[i] % 10;
                    const up = Math.floor(tiles[i] / 10);
                    const txt = document.createElement('div');
                    txt.textContent = lvl + (up ? `+${up}` : '');
                    tile.appendChild(txt);
                }

                grid.appendChild(tile);
            }
        }

        // Simulation gratuite
        function simulatePassive() {
            if (!perHourCached || !lastClaimTime) return;
            const now = Math.floor(Date.now() / 1000);
            const hours = Math.floor((now - lastClaimTime) / 3600);
            if (hours > 0) {
                const earned = hours * perHourCached;
                let g = Number(document.getElementById('gemsAmount').textContent.replace(/,/g,'')) || 0;
                let s = Number(document.getElementById('goldAmount').textContent.replace(/,/g,'')) || 0;
                document.getElementById('gemsAmount').textContent = (g + earned).toLocaleString();
                document.getElementById('goldAmount').textContent = (s + earned).toLocaleString();
                updateGemsConversion();
                lastClaimTime += hours * 3600;
            }
        }

        setInterval(simulatePassive, 60000);

        // Conversion gems ‚Üí BNB/USDT
        async function updateGemsConversion() {
            const gems = Number(document.getElementById('gemsAmount').textContent.replace(/,/g,'')) || 0;
            const bnbVal = gems / 1000000;
            const usdtVal = bnbVal * bnbPriceUSD;

            document.getElementById('gemsValue').textContent = `‚âà ${bnbVal.toFixed(6)} BNB (~${usdtVal.toFixed(2)} USDT)`;

            try {
                const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=binancecoin&vs_currencies=usd');
                const data = await res.json();
                bnbPriceUSD = data.binancecoin?.usd || bnbPriceUSD;
            } catch {}
        }

        // Connexion
        document.getElementById('connectWalletBtn').onclick = connectWallet;
    </script>
</body>
</html>
