<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNBKing - Interface de Jeu</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Karla:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #FFD700;
            --dark-gold: #B8860B;
            --gem: #40E0D0;
            --dark-gem: #20B2AA;
            --bg-dark: #0a0e27;
            --bg-card: #1a1f3a;
            --border: #2a3f5f;
            --text-light: #e0e6ed;
            --text-dim: #8892a6;
            --danger: #ff4757;
            --success: #2ed573;
            --purple: #a855f7;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'Karla', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a0f2e 100%);
            color: var(--text-light);
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5em;
            font-weight: 900;
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .wallet-section { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }

        button {
            padding: 12px 28px;
            border: 2px solid var(--gold);
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--bg-dark);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        button:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(255,215,0,0.4); }

        button.secondary { background: linear-gradient(135deg, var(--gem), var(--dark-gem)); border-color: var(--gem); }
        button.danger { background: linear-gradient(135deg, var(--danger), #c23616); border-color: var(--danger); color: white; }

        .wallet-address {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: monospace;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px; }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
        }

        .stat-label { font-size: 0.9em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 10px; }

        .stat-value { font-size: 2em; font-weight: 700; font-family: 'Cinzel', serif; }

        .stat-value.gold { color: var(--gold); }
        .stat-value.gem  { color: var(--gem); }

        .contract-balance-card {
            background: rgba(255,215,0,0.06);
            border: 1px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 32px;
        }

        .contract-balance-card h3 {
            margin: 0 0 12px 0;
            font-size: 1.3em;
            color: var(--gold);
        }

        .contract-balance-value {
            font-size: 2.1em;
            font-weight: bold;
            color: var(--gold);
        }

        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8em;
            color: var(--gold);
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .input-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dim);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        input, select {
            width: 100%;
            padding: 14px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-light);
        }

        .building-grid {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 2px;
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            max-width: 100%;
            overflow-x: auto;
        }

        .tile {
            aspect-ratio: 1;
            background: var(--border);
            border: 1px solid var(--bg-dark);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
        }

        .tile:hover { transform: scale(1.12); z-index: 5; }

        .tile.occupied {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--bg-dark);
            cursor: default;
        }

        .tile.selected-build {
            background: var(--gem) !important;
            box-shadow: 0 0 12px var(--gem);
        }

        .tile.selected-upgrade {
            background: var(--purple) !important;
            box-shadow: 0 0 12px var(--purple);
            color: white !important;
        }

        .mode-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .mode-btn {
            flex: 1;
            padding: 14px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            border-color: var(--gold);
            color: var(--bg-dark);
        }

        .cost-box {
            padding: 16px;
            background: rgba(255,215,0,0.08);
            border: 1px solid var(--gold);
            border-radius: 8px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: var(--gold);
        }

        .upgrade-box {
            padding: 16px;
            background: rgba(168,85,247,0.08);
            border: 1px solid var(--purple);
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            color: var(--purple);
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .message.success { background: rgba(46,213,115,0.2); color: var(--success); }
        .message.error   { background: rgba(255,71,87,0.2);  color: var(--danger); }
        .message.info    { background: rgba(64,224,208,0.2); color: var(--gem); }

        .hidden { display: none; }

        @media (max-width: 768px) {
            .building-grid { grid-template-columns: repeat(15, 1fr); }
        }
    </style>
</head>
<body>

<div class="container">

    <header>
        <h1>âš”ï¸ BNBKing</h1>
        <div class="wallet-section">
            <button id="connectWalletBtn">Connecter Wallet</button>
            <div id="walletAddress" class="wallet-address hidden"></div>
            <button id="disconnectBtn" class="danger hidden">DÃ©connecter</button>
        </div>
    </header>

    <div id="messageContainer"></div>

    <div id="notConnected" class="section">
        <h2 class="section-title">Bienvenue sur BNBKing</h2>
        <p>Connectez votre wallet Metamask ou Rabby pour jouer.</p>
        <ul style="margin-top:16px; line-height:1.7;">
            <li>âœ“ RÃ©seau BSC (Chain ID 56)</li>
            <li>âœ“ NÃ©cessite du BNB pour les frais</li>
        </ul>
    </div>

    <div id="gameInterface" class="hidden">

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Or</div><div class="stat-value gold" id="goldAmount">0</div></div>
            <div class="stat-card"><div class="stat-label">Gemmes</div><div class="stat-value gem" id="gemsAmount">0</div></div>
            <div class="stat-card"><div class="stat-label">Prod / h</div><div class="stat-value" id="perHourAmount">0</div></div>
            <div class="stat-card"><div class="stat-label">AlliÃ©s</div><div class="stat-value" id="alliesCount">0</div></div>
        </div>

        <!-- Solde contrat BNB -->
        <div class="contract-balance-card">
            <h3>Solde disponible dans le contrat</h3>
            <div id="contractBNBBalance" class="contract-balance-value">Chargement...</div>
        </div>

        <!-- Acheter or -->
        <div class="section">
            <h2 class="section-title">ğŸ’° Acheter de l'Or</h2>
            <div class="input-group">
                <label>Montant BNB</label>
                <input type="number" id="bnbAmount" placeholder="0.1" step="0.01">
            </div>
            <div style="display:flex; gap:12px; align-items:flex-end;">
                <div style="flex:1;">
                    <label>AlliÃ© (optionnel)</label>
                    <input type="text" id="allyAddress" placeholder="0x...">
                </div>
                <button onclick="buyGold()">Acheter</button>
            </div>
        </div>

        <!-- Vendre / Ã‰changer gems -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:24px;">
            <div class="section">
                <h2 class="section-title">Vendre Gemmes</h2>
                <input type="number" id="sellGemsAmount" placeholder="100000">
                <button onclick="sellGems()" style="margin-top:12px; width:100%;">Vendre</button>
            </div>
            <div class="section">
                <h2 class="section-title">Gems â†’ Or</h2>
                <input type="number" id="swapGemsAmount" placeholder="10000">
                <button onclick="swapGemsToGold()" class="secondary" style="margin-top:12px; width:100%;">Ã‰changer</button>
            </div>
        </div>

        <!-- Gestion bÃ¢timents -->
        <div class="section">
            <h2 class="section-title">ğŸ° Gestion des BÃ¢timents</h2>

            <div class="mode-selector">
                <div class="mode-btn active" id="buildModeBtn" onclick="setMode('build')">Construire</div>
                <div class="mode-btn" id="upgradeModeBtn" onclick="setMode('upgrade')">AmÃ©liorer</div>
            </div>

            <div id="modeInfo" class="message info">
                Cliquez sur les cases grises pour construire
            </div>

            <div id="buildPanel">
                <div style="display:flex; gap:20px; flex-wrap:wrap; margin:20px 0;">
                    <div style="min-width:220px;">
                        <label>Niveau</label>
                        <select id="buildingLevel" onchange="updateBuildCost()">
                            <option value="1">Lv1 - 10k (8/h)</option>
                            <option value="2">Lv2 - 28k (24/h)</option>
                            <option value="3">Lv3 - 54k (48/h)</option>
                            <option value="4">Lv4 - 100k (96/h)</option>
                            <option value="5">Lv5 - 250k (248/h)</option>
                            <option value="6">Lv6 - 500k (520/h)</option>
                            <option value="7">Lv7 - 1M (1100/h)</option>
                            <option value="8">Lv8 - 2M (2300/h)</option>
                        </select>
                    </div>
                    <div>
                        <label>CoÃ»t estimÃ©</label>
                        <div class="cost-box" id="buildCost">0 Gold</div>
                    </div>
                </div>

                <div style="display:flex; gap:12px;">
                    <button onclick="placeBuildings()">Construire</button>
                    <button onclick="clearSelection()" class="secondary">Effacer</button>
                </div>
            </div>

            <div id="upgradePanel" class="hidden">
                <div style="margin:20px 0;">
                    <label>Case sÃ©lectionnÃ©e</label>
                    <div class="upgrade-box" id="selectedUpgradeInfo">Aucune</div>
                </div>
                <button onclick="upgradeSelectedTile()" style="background:var(--purple); border:none; color:white; width:100%;">
                    AmÃ©liorer
                </button>
            </div>

            <div class="building-grid" id="buildingGrid"></div>
        </div>

        <!-- Bataille -->
        <div class="section">
            <h2 class="section-title">âš”ï¸ Bataille</h2>
            <div style="margin-bottom:16px;">
                Cooldown 24h â€¢ 1Ê³áµ‰ bataille garantie
            </div>
            <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
                <div style="flex:1; min-width:160px;">
                    <label>Chance victoire %</label>
                    <input type="number" id="winChance" value="50" min="40" max="60">
                </div>
                <button onclick="startBattle()">Lancer</button>
            </div>
            <div id="battleCooldown" style="color:var(--danger); font-weight:bold; margin-top:16px;" class="hidden"></div>
        </div>

        <!-- Config contrat -->
        <div class="section">
            <h2 class="section-title">âš™ï¸ Contrat</h2>
            <input type="text" id="contractAddress" placeholder="0x..." value="">
            <button onclick="setContractAddress()" class="secondary" style="margin-top:12px;">Appliquer</button>
        </div>

    </div>

    <footer style="text-align:center; padding:40px 0; color:var(--text-dim);">
        BNBKing â€¢ BSC Network
    </footer>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Variables globales
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let provider, signer, contract, userAddress;
let selectedTiles = new Set();
let selectedUpgradeTile = null;
let currentMode = 'build';
let kingdomTiles = null;

const CONTRACT_ADDRESS = "0x864EE1d1B51306e30836B84AdE81e39ebB6e8e0C";

const CONTRACT_ABI = [
    "function buyGold(address _ally) external payable",
    "function sellGems(uint256 _gems) external",
    "function swapGemsToGold(uint256 _gems) external",
    "function placeBuildings(uint16[] calldata _tileIds, uint8 _level) external",
    "function upgradeBuilding(uint16 _tileId) external",
    "function battle(uint8 _winChance) external",
    "function getKingdom(address _player) external view returns (tuple(uint32 gold, uint32 gems, uint32 perHour, uint32 alliesCount, uint32 alliesEarned, uint32 claimTime, uint32 battleTime, uint16 battleId, uint8 battlesInRow, bool isWinInRow, address ally, uint8[360] tiles))"
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Solde BNB du contrat â€“ avec fallback RPC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function updateContractBalance() {
    const rpcList = [
        "https://rpc.ankr.com/bsc",
        "https://bsc-dataseed.binance.org/",
        "https://bsc-dataseed1.defibit.io",
        "https://bsc-dataseed1.ninicoin.io",
        "https://bsc-mainnet.nodereal.io/v1"
    ];

    for (const rpcUrl of rpcList) {
        try {
            const pubProvider = new ethers.providers.JsonRpcProvider(rpcUrl);
            const balanceWei = await pubProvider.getBalance(CONTRACT_ADDRESS);
            const balanceBNB = ethers.utils.formatEther(balanceWei);

            const formatted = Number(balanceBNB).toLocaleString(undefined, {
                minimumFractionDigits: 3,
                maximumFractionDigits: 4
            });

            const el = document.getElementById("contractBNBBalance");
            el.textContent = `${formatted} BNB`;
            el.style.color = "var(--gold)";
            return; // succÃ¨s
        } catch (err) {
            console.warn(`RPC ${rpcUrl} a Ã©chouÃ© :`, err.message);
        }
    }

    const el = document.getElementById("contractBNBBalance");
    el.textContent = "Indisponible (RPCs down)";
    el.style.color = "var(--danger)";
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Modes build / upgrade
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function setMode(mode) {
    currentMode = mode;
    document.getElementById('buildModeBtn').classList.toggle('active', mode === 'build');
    document.getElementById('upgradeModeBtn').classList.toggle('active', mode === 'upgrade');
    document.getElementById('buildPanel').classList.toggle('hidden', mode !== 'build');
    document.getElementById('upgradePanel').classList.toggle('hidden', mode !== 'upgrade');

    document.getElementById('modeInfo').textContent = mode === 'build'
        ? "Cliquez sur les cases grises pour construire"
        : "Cliquez sur un bÃ¢timent jaune pour l'amÃ©liorer";

    clearSelection();
    selectedUpgradeTile = null;
    updateUpgradeInfo();

    if (kingdomTiles) renderBuildingGrid(kingdomTiles);
}

function updateBuildCost() {
    const level = parseInt(document.getElementById('buildingLevel').value) || 1;
    const count = selectedTiles.size;

    const costs = [0,10000,28000,54000,100000,250000,500000,1000000,2000000];
    const perh   = [0,8,24,48,96,248,520,1100,2300];

    const totalCost = costs[level] * count;
    const totalPerH = perh[level] * count;

    document.getElementById('buildCost').textContent =
        count === 0 ? "0 Gold" : `${totalCost.toLocaleString()} Gold (+${totalPerH}/h)`;
}

function updateUpgradeInfo() {
    const box = document.getElementById('selectedUpgradeInfo');

    if (selectedUpgradeTile === null || !kingdomTiles) {
        box.textContent = "Aucune case sÃ©lectionnÃ©e";
        return;
    }

    const val = kingdomTiles[selectedUpgradeTile];
    if (val === 0) {
        box.textContent = "Case vide";
        return;
    }

    const level = val % 10;
    const upgrades = Math.floor(val / 10);
    const base = [0,10000,28000,54000,100000,250000,500000,1000000,2000000][level];
    const cost = Math.floor(base * 0.25);

    box.textContent = `Case ${selectedUpgradeTile} â€” Niv ${level}${upgrades ? ` +${upgrades}` : ''} â€¢ CoÃ»t : ${cost.toLocaleString()} Gold`;
}

async function upgradeSelectedTile() {
    if (selectedUpgradeTile === null) {
        showMessage("SÃ©lectionnez un bÃ¢timent Ã  amÃ©liorer", "error");
        return;
    }
    await upgradeBuilding(selectedUpgradeTile);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fonctions manquantes ou importantes
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function clearSelection() {
    selectedTiles.clear();
    updateBuildCost();
    document.querySelectorAll('.tile.selected-build').forEach(t => t.classList.remove('selected-build'));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Grille bÃ¢timents
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderBuildingGrid(tiles) {
    kingdomTiles = tiles;

    const grid = document.getElementById('buildingGrid');
    grid.innerHTML = '';

    for (let i = 0; i < 360; i++) {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.dataset.id = i;

        const val = tiles[i];

        if (val > 0) {
            tile.classList.add('occupied');
            const lvl = val % 10;
            const upg = Math.floor(val / 10);
            tile.textContent = lvl + (upg ? '+' + upg : '');

            if (currentMode === 'upgrade') {
                tile.onclick = () => {
                    selectedUpgradeTile = i;
                    updateUpgradeInfo();
                    document.querySelectorAll('.tile.selected-upgrade').forEach(t=>t.classList.remove('selected-upgrade'));
                    tile.classList.add('selected-upgrade');
                };
                if (selectedUpgradeTile === i) tile.classList.add('selected-upgrade');
            }
        } else if (currentMode === 'build') {
            tile.onclick = () => {
                if (selectedTiles.has(i)) {
                    selectedTiles.delete(i);
                    tile.classList.remove('selected-build');
                } else {
                    selectedTiles.add(i);
                    tile.classList.add('selected-build');
                }
                updateBuildCost();
            };
            if (selectedTiles.has(i)) tile.classList.add('selected-build');
        }

        grid.appendChild(tile);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Wallet / Contrat / DonnÃ©es
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function connectWallet() {
    try {
        if (!window.ethereum) throw new Error("MetaMask / Rabby non dÃ©tectÃ©");

        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== '0x38') {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] });
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        document.getElementById('walletAddress').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        document.getElementById('walletAddress').classList.remove('hidden');
        document.getElementById('disconnectBtn').classList.remove('hidden');
        document.getElementById('connectWalletBtn').classList.add('hidden');
        document.getElementById('notConnected').classList.add('hidden');
        document.getElementById('gameInterface').classList.remove('hidden');

        showMessage("Wallet connectÃ©", "success");

        const saved = localStorage.getItem('contractAddress');
        if (saved) {
            document.getElementById('contractAddress').value = saved;
            await setContractAddress();
        }

        updateContractBalance();

    } catch (err) {
        showMessage("Erreur connexion : " + err.message, "error");
    }
}

function disconnectWallet() {
    provider = signer = contract = userAddress = null;
    document.getElementById('walletAddress').classList.add('hidden');
    document.getElementById('disconnectBtn').classList.add('hidden');
    document.getElementById('connectWalletBtn').classList.remove('hidden');
    document.getElementById('notConnected').classList.remove('hidden');
    document.getElementById('gameInterface').classList.add('hidden');
    showMessage("Wallet dÃ©connectÃ©", "info");
}

async function setContractAddress() {
    const addr = document.getElementById('contractAddress').value.trim();
    if (!ethers.utils.isAddress(addr)) return showMessage("Adresse invalide", "error");

    contract = new ethers.Contract(addr, CONTRACT_ABI, signer);
    localStorage.setItem('contractAddress', addr);
    showMessage("Contrat configurÃ©", "success");
    await loadKingdomData();
}

async function loadKingdomData() {
    if (!contract || !userAddress) return;

    try {
        const kingdom = await contract.getKingdom(userAddress);

        document.getElementById('goldAmount').textContent = kingdom.gold.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        document.getElementById('gemsAmount').textContent = kingdom.gems.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        document.getElementById('perHourAmount').textContent = kingdom.perHour.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        document.getElementById('alliesCount').textContent = kingdom.alliesCount;

        renderBuildingGrid(kingdom.tiles);
        updateBattleCooldown(kingdom.battleTime);
        setMode('build');
    } catch (err) {
        showMessage("Erreur chargement donnÃ©es : " + err.message, "error");
    }
}

function updateBattleCooldown(lastTime) {
    const div = document.getElementById('battleCooldown');
    const now = Math.floor(Date.now() / 1000);
    const remaining = 86400 - (now - lastTime);

    if (remaining > 0) {
        const h = Math.floor(remaining / 3600);
        const m = Math.floor((remaining % 3600) / 60);
        div.textContent = `â³ Cooldown : ${h}h ${m}min`;
        div.classList.remove('hidden');
    } else {
        div.classList.add('hidden');
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Actions contrat
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function buyGold() {
    if (!contract) return showMessage("Contrat non configurÃ©", "error");
    const amt = document.getElementById('bnbAmount').value;
    const ally = document.getElementById('allyAddress').value.trim() || ethers.constants.AddressZero;

    if (!amt || parseFloat(amt) <= 0) return showMessage("Montant invalide", "error");

    try {
        const tx = await contract.buyGold(ally, { value: ethers.utils.parseEther(amt) });
        await tx.wait();
        showMessage("Achat effectuÃ©", "success");
        loadKingdomData();
    } catch (e) { showMessage(e.reason || e.message, "error"); }
}

async function sellGems() {
    if (!contract) return showMessage("Contrat non configurÃ©", "error");
    const amt = document.getElementById('sellGemsAmount').value;
    if (!amt || parseInt(amt) <= 0) return showMessage("QuantitÃ© invalide", "error");

    try {
        const tx = await contract.sellGems(amt);
        await tx.wait();
        showMessage("Vente effectuÃ©e", "success");
        loadKingdomData();
    } catch (e) { showMessage(e.reason || e.message, "error"); }
}

async function swapGemsToGold() {
    if (!contract) return showMessage("Contrat non configurÃ©", "error");
    const amt = document.getElementById('swapGemsAmount').value;
    if (!amt || parseInt(amt) <= 0) return showMessage("QuantitÃ© invalide", "error");

    try {
        const tx = await contract.swapGemsToGold(amt);
        await tx.wait();
        showMessage("Ã‰change effectuÃ©", "success");
        loadKingdomData();
    } catch (e) { showMessage(e.reason || e.message, "error"); }
}

async function placeBuildings() {
    if (!contract) return showMessage("Contrat non configurÃ©", "error");
    if (selectedTiles.size === 0) return showMessage("Aucune case sÃ©lectionnÃ©e", "error");

    const level = parseInt(document.getElementById('buildingLevel').value);
    const tileIds = Array.from(selectedTiles);

    try {
        showMessage("Construction en cours...", "info");
        const tx = await contract.placeBuildings(tileIds, level);
        await tx.wait();
        showMessage("BÃ¢timents construits !", "success");
        clearSelection();
        await loadKingdomData();
    } catch (e) {
        showMessage("Erreur : " + (e.reason || e.message), "error");
    }
}

async function upgradeBuilding(tileId) {
    if (!contract) return showMessage("Contrat non configurÃ©", "error");
    if (tileId < 0 || tileId > 359) return showMessage("ID invalide", "error");

    try {
        showMessage("AmÃ©lioration en cours...", "info");
        const tx = await contract.upgradeBuilding(tileId);
        await tx.wait();
        showMessage("BÃ¢timent amÃ©liorÃ© !", "success");
        selectedUpgradeTile = null;
        updateUpgradeInfo();
        await loadKingdomData();
    } catch (e) {
        showMessage("Erreur : " + (e.reason || e.message), "error");
    }
}

async function startBattle() {
    if (!contract) return showMessage("Contrat non configurÃ©", "error");
    const chance = parseInt(document.getElementById('winChance').value);
    if (isNaN(chance) || chance < 40 || chance > 60) return showMessage("Chance entre 40 et 60%", "error");

    try {
        const tx = await contract.battle(chance);
        await tx.wait();
        showMessage("Bataille terminÃ©e", "success");
        loadKingdomData();
    } catch (e) { showMessage(e.reason || e.message, "error"); }
}

function showMessage(text, type = "info") {
    const container = document.getElementById('messageContainer');
    const msg = document.createElement('div');
    msg.className = `message ${type}`;
    msg.textContent = text;
    container.appendChild(msg);
    setTimeout(() => msg.remove(), 6000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Initialisation et intervalles
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('connectWalletBtn').onclick = connectWallet;
document.getElementById('disconnectBtn').onclick = disconnectWallet;

setInterval(() => {
    if (contract && userAddress) loadKingdomData();
    updateContractBalance();
}, 40000);

updateContractBalance();

    </script>
</body>
</html>
