<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BNBKing - Interface Simple</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --primary: #16a34a;
      --danger: #ef4444;
      --warning: #f59e0b;
      --purple: #a855f7;
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
    }
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 24px;
    }
    h1 { margin: 0; font-size: 1.8rem; }
    .wallet-info {
      padding: 8px 12px;
      background: var(--card);
      border-radius: 12px;
      border: 1px solid #334155;
      font-size: 0.9rem;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    button:hover { opacity: 0.92; transform: translateY(-1px); }
    .connect    { background: var(--primary); color: white; }
    .switch     { background: #334155; color: white; }
    .sell       { background: #0ea5e9; color: white; }
    .battle     { background: var(--danger); color: white; }
    .place      { background: var(--warning); color: black; }
    .upgrade    { background: var(--purple); color: white; }
    .clear      { background: #475569; color: white; }

    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 16px 0; }
    .card {
      background: var(--card);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 16px;
    }
    .section { margin-bottom: 32px; }
    h2 { margin: 0 0 12px; font-size: 1.3rem; }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #475569;
      background: #0f172a;
      color: white;
      font-size: 1rem;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(22px, 1fr));
      gap: 4px;
      max-width: 500px;
      margin-top: 12px;
    }
    .tile {
      aspect-ratio: 1;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 4px;
      display: grid;
      place-items: center;
      font-size: 0.75rem;
      cursor: pointer;
      user-select: none;
    }
    .tile.occupied { background: #334155; cursor: default; }
    .tile.selected-build { outline: 2px solid var(--warning); }
    .tile.selected-upgrade { outline: 2px solid var(--purple); }
    .status { margin: 12px 0; padding: 10px; border-radius: 8px; }
    .success { background: rgba(34,197,94,0.15); color: #86efac; }
    .error   { background: rgba(239,68,68,0.15); color: #fca5a5; }
    .muted   { color: var(--muted); font-size: 0.9rem; }
  </style>
</head>
<body>

<div class="container">

  <header>
    <h1>BNBKing</h1>
    <div>
      <div id="walletInfo" class="wallet-info" style="display:none;"></div>
      <button class="connect" id="connectBtn">Connect Wallet</button>
      <button class="switch" id="switchBtn" style="display:none;">Switch BSC</button>
    </div>
  </header>

  <div id="status" class="status"></div>
  <div id="error" class="status error" style="display:none;"></div>

  <div class="section card">
    <h2>Kingdom</h2>
    <div class="grid-3" id="stats">
      <div><strong>Gold</strong><br><span id="gold">—</span></div>
      <div><strong>Gems</strong><br><span id="gems">—</span></div>
      <div><strong>Per hour</strong><br><span id="perHour">—</span></div>
      <div><strong>Alliés</strong><br><span id="allies">—</span></div>
      <div><strong>Ally</strong><br><span id="ally">—</span></div>
    </div>
  </div>

  <div class="section card">
    <h2>Actions</h2>

    <!-- Vendre Gems -->
    <div style="margin-bottom:20px;">
      <label>Vendre Gems → BNB</label>
      <input id="sellAmount" placeholder="ex: 10000" type="number"/>
      <button class="sell" onclick="sellGems()">Sell Gems</button>
    </div>

    <!-- Battle -->
    <div style="margin-bottom:20px;">
      <label>Battle (cooldown 24h)</label>
      <div id="battleStatus" class="muted">—</div>
      <label>Win chance (40–60)</label>
      <input id="winChance" type="number" min="40" max="60" value="50"/>
      <button class="battle" onclick="doBattle()">Lancer Battle</button>
    </div>

    <!-- Mode Build / Upgrade -->
    <div style="margin:16px 0;">
      <button onclick="setMode('build')" style="background:#16a34a;color:white;">Mode: Placer</button>
      <button onclick="setMode('upgrade')" style="background:#a855f7;color:white;">Mode: Upgrader</button>
    </div>

    <div id="buildPanel" style="display:block;">
      <label>Niveau à placer (1–8)</label>
      <select id="buildLevel">
        <option value="1">Level 1</option>
        <option value="2">Level 2</option>
        <option value="3">Level 3</option>
        <option value="4">Level 4</option>
        <option value="5">Level 5</option>
        <option value="6">Level 6</option>
        <option value="7">Level 7</option>
        <option value="8">Level 8</option>
      </select>
      <div style="margin:12px 0;">
        Cases sélectionnées : <strong id="buildCount">0</strong>
      </div>
      <button class="place" onclick="placeBuildings()">Placer bâtiments</button>
      <button class="clear" onclick="clearBuildSelection()">Clear</button>
    </div>

    <div id="upgradePanel" style="display:none;">
      <div style="margin:12px 0;">
        Case sélectionnée : <strong id="upgradeTile">—</strong>
      </div>
      <button class="upgrade" onclick="upgradeBuilding()">Upgrader bâtiment</button>
    </div>

    <!-- Grille -->
    <div id="grid" class="grid-container"></div>
  </div>

</div>

<script>
  const CONTRACT_ADDRESS = "0x864EE1d1B51306e30836B84AdE81e39ebB6e8e0C";
  const BSC_RPC = "https://bsc-dataseed.bnbchain.org";
  const providerRead = new ethers.providers.JsonRpcProvider(BSC_RPC);

  const ABI = [
    "function getKingdom(address) view returns (tuple(uint32 gold, uint32 gems, uint32 perHour, uint32 alliesCount, uint32 alliesEarned, uint32 claimTime, uint32 battleTime, uint16 battleId, uint8 battlesInRow, bool isWinInRow, address ally, uint8[360] tiles))",
    "function battle(uint8 winChance)",
    "function sellGems(uint256 gems)",
    "function placeBuildings(uint16[] tileIds, uint8 level)",
    "function upgradeBuilding(uint16 tileId)"
  ];

  let provider, signer, account, contractWrite, kingdom = null;
  let mode = "build";
  let selectedBuild = new Set();
  let selectedUpgrade = null;

  const statusEl  = document.getElementById("status");
  const errorEl   = document.getElementById("error");
  const gridEl    = document.getElementById("grid");

  function showStatus(msg) { statusEl.textContent = msg; statusEl.className = "status"; statusEl.style.display = "block"; }
  function showError(msg)  { errorEl.textContent = msg; errorEl.style.display = "block"; setTimeout(()=>errorEl.style.display="none", 8000); }
  function clearMsgs()     { statusEl.style.display = "none"; errorEl.style.display = "none"; }

  async function connect() {
    clearMsgs();
    if (!window.ethereum) return showError("MetaMask / Rabby non détecté");

    try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      account = await signer.getAddress();

      const network = await provider.getNetwork();
      if (Number(network.chainId) !== 56) {
        showStatus("Pas sur BSC → essayez Switch BSC");
        document.getElementById("switchBtn").style.display = "inline-block";
        return;
      }

      document.getElementById("walletInfo").innerHTML = `
        Connecté : ${account.slice(0,6)}…${account.slice(-4)}<br>
        <small style="color:#86efac">BSC Mainnet</small>
      `;
      document.getElementById("walletInfo").style.display = "block";
      document.getElementById("connectBtn").textContent = "Reconnect";

      contractWrite = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
      await loadKingdom();
    } catch (e) {
      showError(e.message || String(e));
    }
  }

  async function switchBSC() {
    try {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: "0x38" }]
      });
      await connect();
    } catch (e) {
      showError(e.message || String(e));
    }
  }

  async function loadKingdom() {
    clearMsgs();
    if (!account) return;

    try {
      const readContract = new ethers.Contract(CONTRACT_ADDRESS, ABI, providerRead);
      const data = await readContract.getKingdom(account);

      kingdom = {
        gold: Number(data.gold),
        gems: Number(data.gems),
        perHour: Number(data.perHour),
        alliesCount: Number(data.alliesCount),
        ally: data.ally,
        tiles: Array.from(data.tiles).map(Number),
        battleTime: Number(data.battleTime)
      };

      document.getElementById("gold").textContent     = kingdom.gold.toLocaleString();
      document.getElementById("gems").textContent     = kingdom.gems.toLocaleString();
      document.getElementById("perHour").textContent  = kingdom.perHour.toLocaleString();
      document.getElementById("allies").textContent   = kingdom.alliesCount;
      document.getElementById("ally").textContent     = kingdom.ally === ethers.constants.AddressZero ? "—" : shortAddr(kingdom.ally);

      renderGrid();
      updateBattleStatus();
    } catch (e) {
      showError("Impossible de charger le kingdom : " + (e.reason || e.message));
    }
  }

  function renderGrid() {
    gridEl.innerHTML = "";
    for (let i = 0; i < 360; i++) {
      const tile = document.createElement("div");
      tile.className = "tile";
      const val = kingdom.tiles[i];
      const level = val % 10;
      const upg = Math.floor(val / 10);

      if (val > 0) {
        tile.classList.add("occupied");
        tile.textContent = level + (upg ? "+"+upg : "");
      } else {
        tile.onclick = () => toggleTile(i);
      }

      if (mode === "build" && selectedBuild.has(i)) tile.classList.add("selected-build");
      if (mode === "upgrade" && selectedUpgrade === i) tile.classList.add("selected-upgrade");

      gridEl.appendChild(tile);
    }
  }

  function toggleTile(id) {
    if (mode === "build") {
      if (kingdom.tiles[id] !== 0) return; // déjà occupé
      if (selectedBuild.has(id)) selectedBuild.delete(id);
      else selectedBuild.add(id);
    } else {
      const val = kingdom.tiles[id];
      if (val === 0) return;
      const level = val % 10;
      const upg = Math.floor(val / 10);
      if (level < 1 || level > 8 || upg >= 9) return;
      selectedUpgrade = (selectedUpgrade === id) ? null : id;
    }
    renderGrid();
    document.getElementById("buildCount").textContent = selectedBuild.size;
    document.getElementById("upgradeTile").textContent = selectedUpgrade ?? "—";
  }

  function setMode(m) {
    mode = m;
    if (m === "build") selectedUpgrade = null;
    else selectedBuild.clear();
    renderGrid();
    document.getElementById("buildPanel").style.display = m === "build" ? "block" : "none";
    document.getElementById("upgradePanel").style.display = m === "upgrade" ? "block" : "none";
  }

  function clearBuildSelection() {
    selectedBuild.clear();
    renderGrid();
    document.getElementById("buildCount").textContent = 0;
  }

  async function sellGems() {
    const amt = document.getElementById("sellAmount").value.trim();
    if (!amt || isNaN(amt) || Number(amt) <= 0) return showError("Montant invalide");
    if (!contractWrite) return showError("Connecte ton wallet d'abord");

    try {
      showStatus("Transaction en cours...");
      const tx = await contractWrite.sellGems(ethers.BigNumber.from(amt));
      await tx.wait();
      showStatus("Vente confirmée !");
      await loadKingdom();
    } catch (e) {
      showError(e.reason || e.message);
    }
  }

  async function doBattle() {
    const chance = Number(document.getElementById("winChance").value);
    if (isNaN(chance) || chance < 40 || chance > 60) return showError("Chance entre 40 et 60");
    if (!contractWrite) return showError("Connecte ton wallet");

    const remaining = battleRemaining();
    if (remaining > 0) return showError(`Cooldown : ${formatTime(remaining)} restant`);

    try {
      showStatus("Bataille en cours...");
      const tx = await contractWrite.battle(chance);
      await tx.wait();
      showStatus("Bataille terminée !");
      await loadKingdom();
    } catch (e) {
      showError(e.reason || e.message);
    }
  }

  function battleRemaining() {
    if (!kingdom) return 0;
    const cooldown = 24 * 3600;
    return Math.max(0, kingdom.battleTime + cooldown - Math.floor(Date.now()/1000));
  }

  function updateBattleStatus() {
    const rem = battleRemaining();
    document.getElementById("battleStatus").textContent = rem > 0 ? `⏳ ${formatTime(rem)} restant` : "✅ Prêt";
  }

  function formatTime(s) {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;
  }

  async function placeBuildings() {
    if (selectedBuild.size === 0) return showError("Sélectionne au moins une case");
    if (!contractWrite) return showError("Connecte ton wallet");

    const level = Number(document.getElementById("buildLevel").value);
    const ids = Array.from(selectedBuild).sort((a,b)=>a-b);

    try {
      showStatus("Construction en cours...");
      const tx = await contractWrite.placeBuildings(ids, level);
      await tx.wait();
      showStatus("Bâtiments placés !");
      selectedBuild.clear();
      await loadKingdom();
    } catch (e) {
      showError(e.reason || e.message);
    }
  }

  async function upgradeBuilding() {
    if (selectedUpgrade === null) return showError("Sélectionne une case à améliorer");
    if (!contractWrite) return showError("Connecte ton wallet");

    try {
      showStatus("Amélioration en cours...");
      const tx = await contractWrite.upgradeBuilding(selectedUpgrade);
      await tx.wait();
      showStatus("Amélioration terminée !");
      selectedUpgrade = null;
      await loadKingdom();
    } catch (e) {
      showError(e.reason || e.message);
    }
  }

  function shortAddr(addr) {
    if (!addr || addr === "0x0000000000000000000000000000000000000000") return "—";
    return addr.slice(0,6) + "…" + addr.slice(-4);
  }

  // Init
  document.getElementById("connectBtn").onclick = connect;
  document.getElementById("switchBtn").onclick = switchBSC;

  setInterval(() => {
    if (kingdom) updateBattleStatus();
  }, 1000);

  // Auto-refresh kingdom toutes les 30s si connecté
  setInterval(() => { if (account && kingdom) loadKingdom(); }, 30000);
</script>

</body>
</html>
